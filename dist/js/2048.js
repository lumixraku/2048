function init(){wrapper=document.querySelector(".wrapper"),wrapper.style.cssText=["width:",WRAPPER_SIZE,"rem ;height:",WRAPPER_SIZE,"rem"].join("");for(var t=1;4>=t;t++)for(var e=1;4>=e;e++)addBlock(t,e,0);setBlock(4,3,2)}function bindEvents(){window.addEventListener("keydown",function(t){switch(t.keyCode){case 87:swipeUp();break;case 83:swipeDown();break;case 65:swipeLeft();break;case 68:swipeRight()}},!1);var t={x:0,y:0},e={x:0,y:0};window.addEventListener("touchstart",function(e){t.x=e.touches[0].pageX,t.y=e.touches[0].pageY,e.preventDefault()},!1),window.addEventListener("touchmove",function(t){e.x=t.touches[0].pageX,e.y=t.touches[0].pageY,t.preventDefault()},!1),window.addEventListener("touchend",function(a){Math.abs(e.y-t.y)>Math.abs(e.x-t.x)&&(e.y<t.y?swipeUp():swipeDown()),Math.abs(e.x-t.x)>Math.abs(e.y-t.y)&&(e.x<t.x?swipeLeft():swipeRight()),a.preventDefault()},!1)}function newBlockELe(){var t=document.createElement("div");return t.classList.add("block"),t.style.width=BLOCK_SIZE+"rem",t.style.height=BLOCK_SIZE+"rem",t}function addBlock(t,e,a){var r=getPosition(t,e),o=newBlockELe();a?(o.setAttribute("data",a),o.className="block val"+a,o.innerText=a+""):(o.setAttribute("data",0),o.classList.add("dark")),o.style.top=r.y+"rem",o.style.left=r.x+"rem",wrapper.appendChild(o),blockList[t-1][e-1]=o}function getBlockBy(t,e){return blockList[t-1][e-1]}function setBlock(t,e,a){var r=blockList[t-1][e-1];a?(r.setAttribute("data",a),r.innerText=a,r.className="block val"+a):(r.setAttribute("data",0),r.innerText="",r.classList.add("dark"))}function blockMerge(t,e){var a=!1,r=e.getAttribute("data");return e.getAttribute("data")&&"0"!=e.getAttribute("data")&&("0"==t.getAttribute("data")?(toDark(e),t.setAttribute("data",r),a=!0):t.getAttribute("data")==e.getAttribute("data")&&(toDark(e),a=!0,scoreEle.innerText=+r+ +scoreEle.innerText,t.setAttribute("data",2*+r))),a}function toDark(t){t.setAttribute("data",0),t.innerText="",t.className="block dark"}function animate(t,e,a){function r(t){return l>i&&(c-=.7,u.style.top=c+"rem",i>=c)?(u.remove(),void o()):i>l&&(c+=.7,u.style.top=c+"rem",c>=i)?(u.remove(),void o()):s>n&&(d-=.7,u.style.left=d+"rem",n>=d)?(u.remove(),void o()):n>d&&(d+=.7,u.style.left=d+"rem",d>=n)?(u.remove(),void o()):void requestAnimationFrame(r)}function o(){"0"!=t.getAttribute("data")?(t.innerText=t.getAttribute("data"),t.className="block val"+t.getAttribute("data")):(t.className="block dark",t.innerText="")}var n=+parseFloat(t.style.left).toFixed(1),i=+parseFloat(t.style.top).toFixed(1),l=+parseFloat(e.style.top).toFixed(1),s=+parseFloat(e.style.left).toFixed(1),c=l,d=s,u=document.createElement("div");u.classList.add("animate"),u.style.top=l+"rem",u.style.left=s+"rem",u.innerText=a,u.className="block val"+a,wrapper.appendChild(u),requestAnimationFrame(r)}function getPosition(t,e){return{x:t*PADDING+(t-1)*BLOCK_SIZE,y:e*PADDING+(e-1)*BLOCK_SIZE}}function swipeUp(){for(var t=1;4>=t;t++)for(var e=2;4>=e;e++){var a,r,o=e,n=e;for(r=getBlockBy(t,e).getAttribute("data");1!=o;)a=blockMerge(getBlockBy(t,o-1),getBlockBy(t,o)),o--,a&&(n=o);n!=e&&animate(getBlockBy(t,n),getBlockBy(t,e),r)}randomAdd(UP)}function swipeDown(){for(var t=1;4>=t;t++)for(var e=3;e>=1;e--){var a,r,o=e,n=e;for(r=getBlockBy(t,e).getAttribute("data");4!=o;)a=blockMerge(getBlockBy(t,o+1),getBlockBy(t,o)),o++,a&&(n=o);n!=e&&animate(getBlockBy(t,n),getBlockBy(t,e),r)}randomAdd(DOWN)}function swipeLeft(){for(var t=1;4>=t;t++)for(var e=2;4>=e;e++){var a,r,o=e,n=e;for(r=getBlockBy(e,t).getAttribute("data");1!=o;)a=blockMerge(getBlockBy(o-1,t),getBlockBy(o,t)),o--,a&&(n=o);n!=e&&animate(getBlockBy(n,t),getBlockBy(e,t),r)}randomAdd(LEFT)}function swipeRight(){for(var t=1;4>=t;t++)for(var e=3;e>=1;e--){var a,r,o=e,n=e;for(r=getBlockBy(e,t).getAttribute("data");4!=o;)a=blockMerge(getBlockBy(o+1,t),getBlockBy(o,t)),o++,a&&(n=o);n!=e&&animate(getBlockBy(n,t),getBlockBy(e,t),r)}randomAdd(RIGHT)}function randomAdd(t){function e(){return s+=.04,l.style.transform="scale("+s+")",s>=1?(r.className="block val"+o,r.innerText=o,void l.remove()):void requestAnimationFrame(e)}function a(t,e){var a,r=[];if(e)for(var o=1;4>=o;o++)a=getBlockBy(o,e),a.getAttribute("data")&&r.push(a);else if(t)for(var n=1;4>=n;n++)a=getBlockBy(t,n),a.getAttribute("data")&&r.push(a);return r}var r,o,n=[];if(t==UP?n=a(0,4):t==DOWN?n=a(0,1):t==LEFT?n=a(4,0):t==RIGHT&&(n=a(1,0)),n.length){var i=~~(Math.random()*n.length);r=n[i],r||console.log(i),o=Math.random()>.5?4:2,r.setAttribute("data",o);var l=document.createElement("div");l.style.width=BLOCK_SIZE+"rem",l.style.height=BLOCK_SIZE+"rem",l.style.position="absolute",l.style.top=r.style.top,l.style.left=r.style.left,l.className="block val"+o,l.innerText=r.getAttribute("data");var s=.1;l.style.transform="scale("+s+")",wrapper.appendChild(l),requestAnimationFrame(e)}}var pxUnit="rem",BLOCK_SIZE=3.2,PADDING=BLOCK_SIZE/5,WRAPPER_SIZE=4*BLOCK_SIZE+5*PADDING,wrapper,blockList=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]],UP=0,LEFT=1,RIGHT=2,DOWN=3,scoreEle=document.querySelector(".score .value");init(),bindEvents();